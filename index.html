<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cubing Tracker Pro - Championship Edition</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0f1220; color: #fff; padding: 20px; }
        #main-title { text-align: center; cursor: pointer; padding: 10px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        #main-title:hover { color: #3b85f5; background: #1a1d2b; }
        
        #controls { text-align: center; margin-bottom: 20px; background: #1a1d2b; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        #nav-bar { margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; align-items: center; }
        .nav-group { display: flex; align-items: center; gap: 5px; background: #252a40; padding: 5px 10px; border-radius: 6px; border: 1px solid #444; }
        
        table { border-collapse: collapse; width: 100%; max-width: 1200px; margin: 0 auto; background: #1a1d2b; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #333; padding: 10px; text-align: center; position: relative; }
        th { background: #252a40; color: #aaa; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .solver-link, .round-link { color: #3b85f5; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .solver-link:hover, .round-link:hover { color: #fff; }

        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        #profile-modal { background: #0f1220; width: 95%; max-width: 1100px; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 12px; border: 1px solid #3b85f5; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #888; }
        
        .medal-box { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .medal { padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
        .gold { background: #ffd700; color: #000; }
        .silver { background: #c0c0c0; color: #000; }
        .bronze { background: #cd7f32; color: #000; }

        .bubble { position: absolute; top: 2px; right: 2px; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 10; pointer-events: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .pr-bubble { background: #3b85f5; color: white; }
        .sr-bubble { background: #28a745; color: white; }
        
        .rank-green { background: #28a745 !important; color: white; font-weight: bold; cursor: pointer; }
        .solve-best { color: #2ecc71 !important; font-weight: bold; }
        .solve-worst { color: #e74c3c !important; font-weight: bold; }
        
        button, select { padding: 8px 14px; background: #252a40; color: #fff; border: 1px solid #444; cursor: pointer; border-radius: 4px; }
        .btn-mini { font-size: 10px; padding: 4px 8px; background: #1a1d2b; }
        .btn-warning { background: #f39c12; color: #000; font-weight: bold; }
        .btn-primary { background: #3498db; }
        .btn-success { background: #27ae60; }
        .btn-export { background: #673ab7; font-weight: bold; }
        .danger { background: #c0392b; border: none; }
        .del-row { color: #555; cursor: pointer; font-weight: bold; font-size: 18px; border: none; background: none; }
        
        [contenteditable] { outline: none; }
        .empty-msg { text-align:center; padding:60px; color:#555; font-style: italic; }
    </style>
</head>
<body>

<h2 id="main-title" onclick="renameTitle()">Cubing Session Tracker</h2>

<div id="controls">
    <button onclick="renameTitle()" style="background:#444">‚úé Rename Session</button>
    <button onclick="addRow()">+ Add Person</button>
    <button onclick="addEvent()">+ Add Event</button>
    <button onclick="addRound()">+ Add Round</button>
    <button onclick="showLeaderboard()" class="btn-warning">üèÜ View Leaderboard</button>
    <button onclick="exportData()" class="btn-primary">Download CSV</button>
    <button onclick="importData()" class="btn-success">Import CSV</button>
    <button onclick="exportStaticHTML()" class="btn-export">Export Results (HTML/PDF)</button>
</div>

<div id="nav-bar"></div>
<div id="table-container"></div>

<div id="modal-overlay" onclick="closeProfile()">
    <div id="profile-modal" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeProfile()">&times;</span>
        <h2 id="modal-name" style="margin-top:0; color:#3b85f5; text-align:center; letter-spacing:1px; margin-bottom:5px;">SOLVER PROFILE</h2>
        <div id="medal-container" class="medal-box"></div>
        <div id="modal-content"></div>
    </div>
</div>

<script>
let state = { title: "Cubing Session Tracker", events: {}, eventOrder: [] };
let activeKey = null;

// --- Helper Functions ---
function parseTime(str) {
    if (!str || str.trim() === "") return null;
    let clean = str.replace(/\[.*?\]/g, '').trim().toLowerCase();
    if (clean === 'dnf' || clean === '‚Äî' || clean === '-') return Infinity;
    if (clean.includes(':')) {
        let p = clean.split(':');
        return (parseFloat(p[0]) * 60) + parseFloat(p[1]);
    }
    return isNaN(parseFloat(clean)) ? null : parseFloat(clean);
}

function formatTime(val) {
    if (val === Infinity) return 'DNF';
    if (val === null || isNaN(val)) return '‚Äî';
    if (val >= 60) {
        let m = Math.floor(val / 60);
        let s = (val % 60).toFixed(3);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }
    return val.toFixed(3);
}

function getAverage(solves) {
    let t = solves.map(parseTime).filter(x => x !== null);
    if (t.length < 5) return null;
    if (t.filter(x => x === Infinity).length >= 2) return Infinity;
    let s = [...t].sort((a,b) => a - b);
    return (s[1] + s[2] + s[3]) / 3;
}

function getSortScore(solves) {
    let t = solves.map(parseTime).filter(x => x !== null);
    if (t.length === 0) return 30000;
    let avg = getAverage(solves);
    if (avg !== null && avg !== Infinity) return avg;
    let validTimes = t.filter(x => x !== Infinity);
    let best = validTimes.length > 0 ? Math.min(...validTimes) : Infinity;
    if (best !== Infinity) return 10000 + best;
    return 20000;
}

// --- App Logic ---
function toggleGreen(idx) {
    let row = state.events[activeKey].rows[idx];
    row.green = !row.green;
    if (row.green) {
        let currentEventName = state.events[activeKey].parent;
        let allRounds = Object.keys(state.events).filter(k => state.events[k].parent === currentEventName);
        let currentIndex = allRounds.indexOf(activeKey);
        if (currentIndex < allRounds.length - 1) {
            let nextRoundKey = allRounds[currentIndex + 1];
            if (!state.events[nextRoundKey].rows.some(r => r.name === row.name)) {
                state.events[nextRoundKey].rows.push({ name: row.name, solves: ["","","","",""], green: false });
            }
        }
    }
    save(); render();
}

function moveEvent(dir) {
    let curP = state.events[activeKey].parent || activeKey;
    let idx = state.eventOrder.indexOf(curP);
    if (dir === -1 && idx > 0) [state.eventOrder[idx], state.eventOrder[idx-1]] = [state.eventOrder[idx-1], state.eventOrder[idx]];
    else if (dir === 1 && idx < state.eventOrder.length - 1) [state.eventOrder[idx], state.eventOrder[idx+1]] = [state.eventOrder[idx+1], state.eventOrder[idx]];
    save(); render();
}

function renameTitle() { let n = prompt("Session Name:", state.title); if(n) { state.title = n; save(); render(); } }
function renameEvent() {
    let oldKey = activeKey && !state.events[activeKey].parent ? activeKey : state.events[activeKey].parent;
    let n = prompt("New Event Name:", oldKey);
    if(n && n !== oldKey) {
        state.events[n] = state.events[oldKey];
        delete state.events[oldKey];
        state.eventOrder = state.eventOrder.map(e => e === oldKey ? n : e);
        Object.keys(state.events).forEach(k => {
            if(state.events[k].parent === oldKey) {
                let newK = n + " - " + k.split(' - ')[1];
                state.events[newK] = state.events[k];
                state.events[newK].parent = n;
                delete state.events[k];
                if(activeKey === k) activeKey = newK;
            }
        });
        if(activeKey === oldKey) activeKey = n;
        save(); render();
    }
}
function renameRound() {
    if(!state.events[activeKey].parent) return;
    let parent = state.events[activeKey].parent;
    let oldRoundName = activeKey.split(' - ')[1];
    let n = prompt("New Round Name:", oldRoundName);
    if(n && n !== oldRoundName) {
        let newKey = `${parent} - ${n}`;
        state.events[newKey] = state.events[activeKey];
        delete state.events[activeKey];
        save(); render(newKey);
    }
}

function getMedalCounts(name) {
    let counts = { gold: 0, silver: 0, bronze: 0 };
    for (let key in state.events) {
        if (!key.toLowerCase().includes('final')) continue;
        let sheet = state.events[key];
        if (!sheet.parent) continue;
        let sorted = [...sheet.rows].sort((a,b) => getSortScore(a.solves) - getSortScore(b.solves));
        let idx = sorted.findIndex(r => r.name === name);
        if (idx === 0) counts.gold++; else if (idx === 1) counts.silver++; else if (idx === 2) counts.bronze++;
    }
    return counts;
}

function showLeaderboard() {
    document.getElementById('modal-name').textContent = "CHAMPIONSHIP LEADERBOARD";
    document.getElementById('medal-container').innerHTML = '';
    let solvers = {};
    Object.values(state.events).forEach(sheet => { sheet.rows.forEach(r => { solvers[r.name] = true; }); });
    let list = Object.keys(solvers).map(name => ({ name, ...getMedalCounts(name) }));
    list.sort((a,b) => (b.gold - a.gold) || (b.silver - a.silver) || (b.bronze - a.bronze));
    let html = `<table><thead><tr><th>Rank</th><th>Solver</th><th class="gold">Gold</th><th class="silver">Silver</th><th class="bronze">Bronze</th><th>Total</th></tr></thead><tbody>`;
    list.forEach((s, i) => {
        if (s.gold + s.silver + s.bronze === 0) return;
        html += `<tr><td>${i+1}</td><td class="solver-link" onclick="showProfile('${s.name.replace(/'/g, "\\'")}')">${s.name}</td><td>${s.gold}</td><td>${s.silver}</td><td>${s.bronze}</td><td>${s.gold+s.silver+s.bronze}</td></tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal-overlay').style.display = 'flex';
}

function showProfile(name) {
    document.getElementById('modal-name').textContent = name.toUpperCase();
    let content = `<table><thead><tr><th>Event</th><th>Round</th><th>Rank</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>Best</th><th>Average</th></tr></thead><tbody>`;
    let medals = getMedalCounts(name);
    let found = false;
    for (let key in state.events) {
        let sheet = state.events[key];
        if (!sheet.parent) continue;
        let sorted = [...sheet.rows].sort((a,b) => getSortScore(a.solves) - getSortScore(b.solves));
        let idx = sorted.findIndex(r => r.name === name);
        if (idx !== -1) {
            found = true;
            let p = sorted[idx];
            let tp = p.solves.map(parseTime);
            let bV = tp.filter(x => x !== null && x !== Infinity).length > 0 ? Math.min(...tp.filter(x => x !== null && x !== Infinity)) : Infinity;
            let wV = tp.filter(x => x !== null).length > 0 ? Math.max(...tp.filter(x => x !== null)) : null;

            content += `<tr><td>${sheet.parent}</td><td><span class="round-link" onclick="goToRound('${key.replace(/'/g, "\\'")}')">${key.split(' - ')[1]}</span></td>
                <td class="${p.green ? 'rank-green' : ''}">${idx+1}</td>
                ${p.solves.map(s => {
                    let val = parseTime(s);
                    let cls = (val !== null && val !== Infinity && val === bV) ? "solve-best" : (val !== null && val === wV ? "solve-worst" : "");
                    return `<td class="${cls}">${s||'‚Äî'}</td>`;
                }).join('')}
                <td>${formatTime(bV)}${p.bRec?`<span class="bubble ${p.bRec.toLowerCase()}-bubble">${p.bRec}</span>`:''}</td>
                <td>${formatTime(getAverage(p.solves))}${p.aRec?`<span class="bubble ${p.aRec.toLowerCase()}-bubble">${p.aRec}</span>`:''}</td></tr>`;
        }
    }
    document.getElementById('medal-container').innerHTML = `<div class="medal gold">ü•á ${medals.gold}</div><div class="medal silver">ü•à ${medals.silver}</div><div class="medal bronze">ü•â ${medals.bronze}</div>`;
    document.getElementById('modal-content').innerHTML = found ? content + `</tbody></table>` : `<div class="empty-msg">No history.</div>`;
    document.getElementById('modal-overlay').style.display = 'flex';
}

function goToRound(key) { closeProfile(); if(typeof renderInteractive === 'function') renderInteractive(key); else render(key); }
function closeProfile() { document.getElementById('modal-overlay').style.display = 'none'; }

function addEvent() { let n = prompt("Event Name:"); if(n) { state.events[n] = { parent: null, rows: [] }; if(!state.eventOrder.includes(n)) state.eventOrder.push(n); render(n); } }
function addRound() { let p = activeKey ? (state.events[activeKey].parent || activeKey) : null; if(!p) return; let n = prompt("Round Name:"); if(n) { let k = `${p} - ${n}`; state.events[k] = { parent: p, rows: [] }; render(k); } }
function deleteEvent() { let k = activeKey && !state.events[activeKey].parent ? activeKey : state.events[activeKey].parent; if(confirm(`Delete "${k}"?`)) { Object.keys(state.events).forEach(x => { if(state.events[x].parent === k) delete state.events[x]; }); delete state.events[k]; state.eventOrder = state.eventOrder.filter(o => o !== k); save(); render(); } }
function deleteRound() { if(confirm("Delete round?")) { delete state.events[activeKey]; save(); render(); } }
function addRow() { if(!activeKey || !state.events[activeKey].parent) return alert("Select a Round."); state.events[activeKey].rows.push({ name: "New Solver", solves: ["","","","",""], green: false }); render(); }
function deleteRow(idx) { if(confirm("Delete row?")) { state.events[activeKey].rows.splice(idx, 1); save(); render(); } }
function toggleRec(idx, f) { let c = state.events[activeKey].rows[idx][f]; state.events[activeKey].rows[idx][f] = (!c ? 'PR' : (c === 'PR' ? 'SR' : null)); save(); render(); }
function save() { localStorage.setItem('CUBING_SESSION_MASTER', JSON.stringify(state)); }

function render(newKey = null) {
    if(newKey) activeKey = newKey;
    document.getElementById('main-title').textContent = state.title;
    const nav = document.getElementById('nav-bar'); nav.innerHTML = '';
    if(state.eventOrder.length === 0) return;
    if(!activeKey || !state.events[activeKey]) activeKey = state.eventOrder[0];

    let n1 = document.createElement('div'); n1.className = 'nav-group';
    n1.insertAdjacentHTML('beforeend', `<button onclick="moveEvent(-1)" class="btn-mini">‚Üë</button><button onclick="moveEvent(1)" class="btn-mini">‚Üì</button><button onclick="renameEvent()" class="btn-mini">Rename</button><button onclick="deleteEvent()" class="danger btn-mini">Delete</button>`);
    let sE = document.createElement('select'); 
    state.eventOrder.forEach(m => { let o = document.createElement('option'); o.value = m; o.textContent = m; if(activeKey === m || state.events[activeKey].parent === m) o.selected = true; sE.appendChild(o); });
    sE.onchange = (e) => render(e.target.value); n1.appendChild(sE); nav.appendChild(n1);

    let curP = state.events[activeKey].parent || activeKey;
    let rds = Object.keys(state.events).filter(k => state.events[k].parent === curP);
    if(rds.length > 0 || state.events[activeKey].parent) {
        let n2 = document.createElement('div'); n2.className = 'nav-group';
        let sR = document.createElement('select'); sR.insertAdjacentHTML('beforeend', `<option value="${curP}">-- Select Round --</option>`);
        rds.forEach(r => { let o = document.createElement('option'); o.value = r; o.textContent = r.split(' - ')[1]; if(activeKey === r) o.selected = true; sR.appendChild(o); });
        sR.onchange = (e) => render(e.target.value); n2.appendChild(sR);
        if(state.events[activeKey].parent) n2.insertAdjacentHTML('beforeend', `<button onclick="renameRound()" class="btn-mini">Rename</button><button onclick="deleteRound()" class="danger btn-mini">Delete</button>`);
        nav.appendChild(n2);
    }

    const cont = document.getElementById('table-container'); cont.innerHTML = '';
    if(!state.events[activeKey].parent) { cont.innerHTML = `<div class="empty-msg">Select a sub-round for ${activeKey}.</div>`; return; }

    state.events[activeKey].rows.sort((a,b) => getSortScore(a.solves) - getSortScore(b.solves));
    let t = document.createElement('table');
    t.innerHTML = `<thead><tr><th>Rank</th><th>Name</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>Best</th><th>Average</th><th></th></tr></thead>`;
    let tb = document.createElement('tbody');
    state.events[activeKey].rows.forEach((r, i) => {
        let tp = r.solves.map(parseTime);
        let bV = tp.filter(x => x !== null && x !== Infinity).length > 0 ? Math.min(...tp.filter(x => x !== null && x !== Infinity)) : (tp.includes(Infinity) ? Infinity : null);
        let wV = tp.filter(x => x !== null).length > 0 ? Math.max(...tp.filter(x => x !== null)) : null;
        let tr = document.createElement('tr');
        tr.innerHTML = `<td class="${r.green?'rank-green':''}" onclick="toggleGreen(${i})">${i+1}</td>
            <td style="text-align:left; padding-left:15px;"><span class="solver-link" onclick="showProfile('${r.name.replace(/'/g, "\\'")}')">${r.name}</span> <span style="font-size:10px; cursor:pointer; opacity:0.3;" onclick="let n=prompt('Name:', '${r.name}'); if(n){state.events['${activeKey}'].rows[${i}].name=n; save(); render();}">‚úé</span></td>
            ${r.solves.map((s, si) => { let p = parseTime(s); let cls = (p !== null && p !== Infinity && p === bV) ? "solve-best" : (p !== null && p === wV ? "solve-worst" : ""); return `<td contenteditable class="${cls}" onblur="state.events['${activeKey}'].rows[${i}].solves[${si}] = this.innerText; save(); render();">${s}</td>`; }).join('')}
            <td onclick="toggleRec(${i}, 'bRec')">${formatTime(bV)}${r.bRec?`<span class="bubble ${r.bRec.toLowerCase()}-bubble">${r.bRec}</span>`:''}</td>
            <td onclick="toggleRec(${i}, 'aRec')">${formatTime(getAverage(r.solves))}${r.aRec?`<span class="bubble ${r.aRec.toLowerCase()}-bubble">${r.aRec}</span>`:''}</td>
            <td><button class="del-row" onclick="deleteRow(${i})">&times;</button></td>`;
        tb.appendChild(tr);
    });
    t.appendChild(tb); cont.appendChild(t);
}

function exportData() {
    let csv = `TITLE,${state.title}\nORDER,${state.eventOrder.join('|')}\n`;
    for(let k in state.events) {
        let s = state.events[k]; csv += `SHEET,"${k}","${s.parent||""}"\n`;
        if(s.parent) { csv += `Rank,Name,S1,S2,S3,S4,S5,Best,Average\n`; s.rows.forEach((r, i) => { csv += `"${(i+1)+(r.green?" [G]":"")}","${r.name}","${r.solves[0]}","${r.solves[1]}","${r.solves[2]}","${r.solves[3]}","${r.solves[4]}","${r.bRec?` [${r.bRec}]`:""}","${r.aRec?` [${r.aRec}]`:""}"\n`; }); }
    }
    let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `cubing_tracker.csv`; a.click();
}

function importData() {
    let inp = document.createElement('input'); inp.type='file';
    inp.onchange = e => {
        let fr = new FileReader(); fr.onload = ev => {
            let ls = ev.target.result.split('\n'); let nS = { title: "Cubing Session Tracker", events: {}, eventOrder: [] }; let cK = null;
            ls.forEach(l => {
                let p = l.split(',').map(x => x.replace(/^"|"$/g, '').trim());
                if(p[0] === 'TITLE') nS.title = p[1]; else if(p[0] === 'ORDER') nS.eventOrder = p[1].split('|');
                else if(p[0] === 'SHEET') { cK = p[1]; nS.events[cK] = { parent: p[2]||null, rows: [] }; if(!nS.events[cK].parent && !nS.eventOrder.includes(cK)) nS.eventOrder.push(cK); }
                else if(cK && p.length >= 2 && !['Rank','SHEET','TITLE','ORDER'].includes(p[0])) {
                    nS.events[cK].rows.push({ green: p[0].includes('[G]'), name: p[1] || "Unnamed", solves: [p[2]||"", p[3]||"", p[4]||"", p[5]||"", p[6]||""], bRec: p[7]?.includes('[PR]') ? 'PR' : (p[7]?.includes('[SR]') ? 'SR' : null), aRec: p[8]?.includes('[PR]') ? 'PR' : (p[8]?.includes('[SR]') ? 'SR' : null) });
                }
            });
            state = nS; activeKey = state.eventOrder[0]; save(); render();
        };
        fr.readAsText(e.target.files[0]);
    };
    inp.click();
}

function exportStaticHTML() {
    const jsonState = JSON.stringify(state);
    const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${state.title} - Results</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0f1220; color: #fff; padding: 20px; }
        h2 { text-align: center; color: #3b85f5; }
        #nav-bar { margin: 15px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .nav-group { display: flex; align-items: center; gap: 5px; background: #252a40; padding: 10px 18px; border-radius: 8px; border: 1px solid #3b85f5; }
        table { border-collapse: collapse; width: 100%; max-width: 1200px; margin: 0 auto 40px auto; background: #1a1d2b; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #333; padding: 10px; text-align: center; position: relative; }
        th { background: #252a40; color: #aaa; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .solver-link, .round-link { color: #3b85f5; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .bubble { position: absolute; top: 2px; right: 2px; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .pr-bubble { background: #3b85f5; color: white; } .sr-bubble { background: #28a745; color: white; }
        .rank-green { background: #28a745 !important; color: white; }
        .solve-best { color: #2ecc71 !important; font-weight: bold; }
        .solve-worst { color: #e74c3c !important; font-weight: bold; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        #profile-modal { background: #0f1220; width: 95%; max-width: 1100px; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 12px; border: 1px solid #3b85f5; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #888; }
        .medal-box { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .medal { padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
        .gold { background: #ffd700; color: #000; } .silver { background: #c0c0c0; color: #000; } .bronze { background: #cd7f32; color: #000; }
        select { padding: 8px 14px; background: #0f1220; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; }
        @media print { .no-print, #nav-bar, #interactive-container { display: none !important; } .print-view { display: block !important; } table { color: black; background: white; } th, td { border: 1px solid #000; } h2, h3 { color: black; } }
        @media screen { .print-view { display: none; } }
    </style>
</head>
<body>
    <div class="no-print" style="text-align:center;">
        <h2>${state.title}</h2>
        <button onclick="showLeaderboard()" style="padding:10px 20px; background:#f39c12; color:black; font-weight:bold; border:none; border-radius:5px; cursor:pointer;">üèÜ View Championship Leaderboard</button>
        <button onclick="window.print()" style="padding:10px 20px; background:#3b85f5; color:white; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">Print PDF</button>
    </div>
    <div id="nav-bar" class="no-print"></div>
    <div id="interactive-container" class="no-print"></div>
    <div id="print-view" class="print-view"></div>
    <div id="modal-overlay" onclick="closeProfile()"><div id="profile-modal" onclick="event.stopPropagation()"><span class="close-modal" onclick="closeProfile()">&times;</span><h2 id="modal-name"></h2><div id="medal-container" class="medal-box"></div><div id="modal-content"></div></div></div>
    <script>
        const state = ${jsonState}; let activeKey = null;
        ${parseTime.toString()} ${formatTime.toString()} ${getAverage.toString()} ${getSortScore.toString()} ${getMedalCounts.toString()} ${showProfile.toString()} ${showLeaderboard.toString()} ${goToRound.toString()} ${closeProfile.toString()}
        function generateTable(key) {
            const s = state.events[key]; if(!s || !s.parent) return '';
            const rows = [...s.rows].sort((a,b) => getSortScore(a.solves) - getSortScore(b.solves));
            let h = '<h3>'+key+'</h3><table><thead><tr><th>Rank</th><th>Name</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>Best</th><th>Average</th></tr></thead><tbody>';
            rows.forEach((r, i) => {
                let tp = r.solves.map(parseTime); 
                let bV = tp.filter(x=>x!==null&&x!==Infinity).length>0?Math.min(...tp.filter(x=>x!==null&&x!==Infinity)):Infinity;
                let wV = tp.filter(x=>x!==null).length>0?Math.max(...tp.filter(x=>x!==null)):null;
                h += '<tr><td class="'+(r.green?'rank-green':'')+'">'+(i+1)+'</td><td style="text-align:left; padding-left:15px;"><span class="solver-link" onclick="showProfile(\\''+r.name.replace(/'/g, "\\\\'")+'\\')">'+r.name+'</span></td>';
                r.solves.forEach(v => {
                    let val = parseTime(v);
                    let cls = (val !== null && val !== Infinity && val === bV) ? "solve-best" : (val !== null && val === wV ? "solve-worst" : "");
                    h+='<td class="'+cls+'">'+(v||'‚Äî')+'</td>';
                });
                h += '<td>'+formatTime(bV)+(r.bRec?'<span class="bubble '+r.bRec.toLowerCase()+'-bubble">'+r.bRec+'</span>':'')+'</td><td>'+formatTime(getAverage(r.solves))+(r.aRec?'<span class="bubble '+r.aRec.toLowerCase()+'-bubble">'+r.aRec+'</span>':'')+'</td></tr>';
            });
            return h + '</tbody></table>';
        }
        function renderInteractive(newK = null) {
            if(newK) activeKey = newK; const nav = document.getElementById('nav-bar'); nav.innerHTML = '';
            if(!activeKey) activeKey = state.eventOrder[0];
            let n1 = document.createElement('div'); n1.className='nav-group';
            let sE = document.createElement('select'); state.eventOrder.forEach(e => { let o=document.createElement('option'); o.value=e; o.textContent=e; if(activeKey===e||state.events[activeKey].parent===e) o.selected=true; sE.appendChild(o); });
            sE.onchange=(e)=>renderInteractive(e.target.value); n1.appendChild(sE); nav.appendChild(n1);
            let curP = state.events[activeKey].parent || activeKey; let rds = Object.keys(state.events).filter(k=>state.events[k].parent===curP);
            if(rds.length>0) {
                let n2 = document.createElement('div'); n2.className='nav-group';
                let sR = document.createElement('select'); sR.insertAdjacentHTML('beforeend', '<option value="'+curP+'">-- Select Round --</option>');
                rds.forEach(r=>{ let o=document.createElement('option'); o.value=r; o.textContent=r.split(' - ')[1]; if(activeKey===r) o.selected=true; sR.appendChild(o); });
                sR.onchange=(e)=>renderInteractive(e.target.value); n2.appendChild(sR); nav.appendChild(n2);
            }
            document.getElementById('interactive-container').innerHTML = state.events[activeKey].parent ? generateTable(activeKey) : '<div style="text-align:center; padding:50px;">Select a round.</div>';
        }
        window.onload = () => {
            let pView = ''; Object.keys(state.events).forEach(k => { if(state.events[k].parent) pView += generateTable(k); });
            document.getElementById('print-view').innerHTML = pView; renderInteractive();
        };
    <\/script>
</body>
</html>`;
    let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([htmlContent], {type:'text/html'})); a.download = `competition_results.html`; a.click();
}

window.onload = () => { 
    let s = localStorage.getItem('CUBING_SESSION_MASTER'); 
    if(s) { state = JSON.parse(s); if(!state.eventOrder) state.eventOrder = Object.keys(state.events).filter(k => !state.events[k].parent); }
    render(); 
};
</script>
</body>
</html>
